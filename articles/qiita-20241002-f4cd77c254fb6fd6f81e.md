---
title: "Aurora MySQL ãŒ RDS Data API ã‚’é‚ã«ã‚µãƒãƒ¼ãƒˆï¼AppSync ã§çˆ†é€Ÿ GraphQL API "
emoji: "ğŸ˜€"
type: "tech"
topics: [AWS,Aurora,AppSync]
published: false
published_at: 2024-10-02 15:52
---

## ã¯ã˜ã‚ã«

:::note warn
æœ¬è¨˜äº‹ã¯ 2024 å¹´ 10 æœˆ 2 æ—¥æ™‚ç‚¹ã®æƒ…å ±ã«åŸºã¥ã„ã¦åŸ·ç­†ã—ã¦ã„ã¾ã™ã€‚
å†…å®¹ã«ä¸å‚™ã‚ã‚Šã¾ã—ãŸã‚‰æ°—è»½ã«ã‚³ãƒ¡ãƒ³ãƒˆãã ã•ã„ï¼
:::

ã“ã‚“ã«ã¡ã¯ã€‚[ã„ãªã‚Šã](https://twitter.com/inada_riku)ã§ã™âœ‹

2023 å¹´ 11 æœˆ 27 æ—¥ã«ã€AWS AppSync ã¯ RDS Data API ã‚’ä½¿ç”¨ã—ã¦ Amazon Aurora ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å¯¾ã—ã¦[ã‚¤ãƒ³ãƒˆãƒ­ã‚¹ãƒšã‚¯ã‚·ãƒ§ãƒ³](https://graphql.org/learn/introspection/)ã‚’è¡Œã†ã“ã¨ã§ã€æ¤œå‡ºã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«ã«é©åˆã—ãŸ GraphQL API ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’ç°¡å˜ã«ä½œæˆã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚

https://aws.amazon.com/jp/about-aws/whats-new/2023/11/aws-appsync-aurora-clusters-rds-data-api/

ä»¥ä¸‹ã®è¨˜äº‹ã§ã¯ã€ã“ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ Amazon Aurora Serverless v2 (PostgreSQL) ã«è©¦ã—ãŸã‚‚ã®ã§ã™ã€‚ã—ã‹ã—ã€å‰å›è¨˜äº‹ã®åŸ·ç­†æ™‚ç‚¹ã§ã¯ Aurora MySQL ã§ã¯ã€Data API ã¯ Aurora Serverless v1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã®ã¿ã‚µãƒãƒ¼ãƒˆã ã£ãŸãŸã‚ã€ã‚ã¨ä¸€æ­©ã®æ¤œè¨¼ã¨ãªã‚Šã¾ã—ãŸã€‚

https://qiita.com/inada_riku/items/5f058e34bf8c0737f588

ãã‚“ãªè¨˜äº‹ã‚’æ›¸ã„ãŸã“ã¨ã™ã‚‰ã•ã£ã±ã‚Šã¨å¿˜ã‚Œã¦ãŸã®ã§ã™ãŒã€å…ˆæ—¥ X ã‚’çœºã‚ã¦ã„ã‚‹ã¨ã€ã“ã‚“ãªã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã—ãŸã€‚ã€Œé‚ã«æ¥ãŸï¼ã€ã¨æ€ã„ã€Aurora MySQL ã§ã‚‚æ—©é€Ÿè©¦ã—ã¦ã¿ã‚‹ã“ã¨ã¨ã—ã¾ã™ã€‚

https://aws.amazon.com/jp/about-aws/whats-new/2024/09/amazon-aurora-mysql-rds-data-api/

## RDS Data API ã®å¯¾å¿œçŠ¶æ³
æ¤œè¨¼ã‚’å§‹ã‚ã‚‹å‰ã«ã€è‡ªåˆ†ã®ç†è§£ã®ãŸã‚ã«ã‚‚ RDS Data API ã®ä»Šã¾ã§ã®å¯¾å¿œçŠ¶æ³ã«ã¤ã„ã¦èª¿ã¹ã¦ã¿ã¾ã—ãŸã€‚

<table>
  <thead>
    <tr>
      <th rowspan="2">ã‚¨ãƒ³ã‚¸ãƒ³</th>
      <th rowspan="2">ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚¿ã‚¤ãƒ—</th>
      <th colspan="2">2023</th>
      <th>2024</th>
    </tr>
    <tr>
      <th>- 12/20</th>
      <th>12/21 -</th>
      <th>9/26 -</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="2">PostgreSQL</td>
      <td>Serverless v2 / Provisioned</td>
      <td>Ã—</td>
      <td>â—‹</td>
      <td>â—‹</td>
    </tr>
    <tr>
      <td>Serverless v1</td>
      <td>â—‹</td>
      <td>â—‹</td>
      <td>â—‹</td>
    </tr>
    <tr>
      <td rowspan="2">MySQL</td>
      <td>Serverless v2 / Provisioned</td>
      <td>Ã—</td>
      <td>Ã—</td>
      <td>â—‹</td>
    </tr>
    <tr>
      <td>Serverless v1</td>
      <td>â—‹</td>
      <td>â—‹</td>
      <td>â—‹</td>
    </tr>
  </tbody>
</table>

2023 å¹´ 12 æœˆ 21 æ—¥ã«ä»¥ä¸‹ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒæ¥ã¾ã—ãŸã€‚

https://aws.amazon.com/jp/about-aws/whats-new/2023/12/amazon-aurora-postgresql-rds-data-api/

2024 å¹´ 9 æœˆ 26 æ—¥ã«ä»¥ä¸‹ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒæ¥ã¾ã—ãŸã€‚

https://aws.amazon.com/jp/about-aws/whats-new/2024/09/amazon-aurora-mysql-rds-data-api/

ä½™è«‡ã§ã™ãŒã€[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/aurora-serverless.html)ã«ã‚‚ã‚ã‚‹ã‚ˆã†ã«ã€MySQL 8.0 ã¾ãŸã¯ PostgreSQL 13 ä¸Šã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã§ãã‚‹å ´åˆã¯ã€Aurora Serverless v2 ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

:::note alert
**Important** ([å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/AuroraUserGuide/aurora-serverless.html)ã‹ã‚‰å¼•ç”¨)
Aurora has two generations of serverless technology, Aurora Serverless v2 and Aurora Serverless v1. If your application can run on MySQL 8.0 or PostgreSQL 13, we recommend that you use Aurora Serverless v2. Aurora Serverless v2 scales more quickly and in a more granular way. Aurora Serverless v2 also has more compatibility with other Aurora features such as reader DB instances. Thus, if you're already familiar with Aurora, you don't have to learn as many new procedures or limitations to use Aurora Serverless v2 as with Aurora Serverless v1.
:::

## ã‚„ã£ã¦ã¿ãŸ

ã§ã¯ã€ã‚„ã£ã¦ã„ãã¾ã™ã€‚åŸºæœ¬çš„ãªæ‰‹é †ã«é–¢ã—ã¦ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒªãƒ³ã‚¯ã‚’è¼‰ã›ã¦ã„ã‚‹ã®ã§ãã¡ã‚‰ã‚’å‚ç…§ãã ã•ã„ã€‚

### Step1. Amazon Aurora Serverless v2 (MySQL) ã®ä½œæˆ

ã¾ãšã€Aurora Serverless v2 (MySQL) ã® DB ã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä½œæˆã—ã¾ã™ã€‚æ‰‹é †ã«ã¤ã„ã¦ã¯ã€Œ[Aurora MySQL DB ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ä½œæˆã¨æ¥ç¶š](https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/AuroraUserGuide/CHAP_GettingStartedAurora.CreatingConnecting.Aurora.html)ã€ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

:::note warn
æ³¨æ„
ã‚¨ãƒ³ã‚¸ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯`Aurora MySQL 3.05.2 (compatible with MySQL 8.0.32) - ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 8.0` ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€`Aurora MySQL 3.07.0 (compatible with MySQL 8.0.36)` ã«å¤‰ãˆã‚‹å¿…è¦ãŒã‚ã‚‹ç‚¹ã ã‘æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
![screenshot 8.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3625536/5ef97701-e68a-f607-2567-d78844989178.png)
:::

ã¾ãŸã€DB ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ä½œæˆæ™‚ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã§ãã‚‹ã®ã§ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¾ã™ã€‚å¿˜ã‚Œã¦ã—ã¾ã£ãŸå ´åˆã‚‚ã‚ã¨ã‹ã‚‰æœ‰åŠ¹åŒ–ã¯å¯èƒ½ã§ã™ã€‚

![screenshot 7.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3625536/7c0cfb24-51e6-5aca-f3d8-24a2b6011bf8.png)

èªè¨¼æƒ…å ±ã¯ AWS Secret Manager ã§ç®¡ç†ã—ã¾ã™ã€‚å¾Œã»ã©ã€èªè¨¼æƒ…å ±ã¯ AWS AppSync ã‹ã‚‰ã‚¤ãƒ³ãƒˆãƒ­ã‚¹ãƒšã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿæ–½ã™ã‚‹éš›ã«ã‚‚åˆ©ç”¨ã—ã¾ã™ã€‚

![screenshot 9.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3625536/c3d223a0-3d99-bde4-19a0-9974ff4f0046.png)

DB ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ä½œæˆãŒå®Œäº†ã—ãŸã‚‰ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½œæˆã‚’è¡Œã„ã¾ã™ã€‚ä»Šå›ã¯ã€Œsample_dbã€ã¨ã—ã¾ã™ã€‚

```
CREATE DATABASE sample_db;
```

æ¬¡ã«ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆã‚’è¡Œã„ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã«ã—ã¾ã™ã€‚

```sql
CREATE TABLE conversations (  
id INT NOT NULL PRIMARY KEY,  
name VARCHAR(255) NOT NULL,  
created_at DATETIME DEFAULT CURRENT_TIMESTAMP  
);  
  
CREATE TABLE messages (  
id VARCHAR(36) PRIMARY KEY,  
conversation_id INT NOT NULL,  
sub VARCHAR(36) NOT NULL,  
body TEXT NOT NULL,  
created_at DATETIME DEFAULT CURRENT_TIMESTAMP,  
FOREIGN KEY (conversation_id) REFERENCES conversations(id)  
);  
  
CREATE TABLE conversation_participants (  
conversation_id INT NOT NULL,  
sub varchar(36) NOT NULL,  
last_read_at DATETIME,  
PRIMARY KEY (conversation_id, sub),  
FOREIGN KEY (conversation_id) REFERENCES conversations(id)  
);
```

ãƒ†ãƒ¼ãƒãƒ«ãŒæ­£å¸¸ã«ä½œæˆã•ã‚ŒãŸã‹ç¢ºèªã—ã¾ã™ã€‚
```
MySQL [sample_db]> show tables;
+---------------------------+
| Tables_in_sample_db       |
+---------------------------+
| conversation_participants |
| conversations             |
| messages                  |
+---------------------------
3 rows in set (0.002 sec)
```

### Step2. GraphQL API ã®ä½œæˆ

æ¬¡ã«ã€GraphQL API ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚GraphQL API ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã§ã€ŒAmazon Aurora ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‹ã‚‰å§‹ã‚ã‚‹ - Newã€ã‚’é¸æŠã—ã€æ¬¡ã«é€²ã¿ã¾ã™ã€‚

![screenshot 4.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3625536/4b56ac8c-aa13-75d5-2b8d-c2e935598186.png)

æ¬¡ã«ã€API åã«ã‚ã‹ã‚Šæ˜“ã„åå‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚ä»Šå›ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã€ŒMy AppSync APIã€ã¨ã—ã¾ã—ãŸã€‚

![screenshot 5.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3625536/f3d804da-6b93-ac9a-7427-aea95153d21d.png)

æ¬¡ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é¸æŠã—ã¾ã™ã€‚

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2023-12-22 16.13.17.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3625536/c105701d-1b6f-7771-1acf-a8f8fa93673f.png)

ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é¸æŠã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ¥ç¶šã—ãŸã„ Amazon Aurora ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒé¸æŠå‡ºæ¥ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯ã€Œsample_dbã€ã¨å…¥åŠ›ã—ã¾ã™ã€‚AWS Secret  Manager ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯ Step1 ã§ä½œæˆæ¸ˆã¿ã®ã‚‚ã®ã‚’é¸æŠã—ã¾ã™ã€‚å…¥åŠ›ãŒçµ‚ãˆãŸã‚‰ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3625536/b46ab22c-2691-d48c-a5c6-ac554e38d8ad.png)

ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã‚¤ãƒ³ãƒˆãƒ­ã‚¹ãƒšã‚¯ã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã€ä¸‹ã®ç”»åƒã®ã‚ˆã†ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸã€‚ã‚¿ã‚¤ãƒ—åã¯ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚(ç”»åƒã¯å¤‰æ›´å‰ã§ã™ã€‚)

* `Conversation_participants` : `Participant`
* `Conversations` : `Conversation`
* `Messages` : `Message`

å•é¡Œãªã‘ã‚Œã°ã€ã€Œæ¬¡ã¸ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![screenshot 13.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3625536/ca5c53f3-d26f-636b-1d8c-811f198d607b.png)

ã‚¹ã‚­ãƒ¼ãƒã®è¨­å®šã§ã¯ã€ã‚¯ã‚¨ãƒªã®ã¿ã‚’ä½œæˆã™ã‚‹ã‹ã€ã‚¯ã‚¨ãƒªã€ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã‹ã‚’é¸æŠã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚ä»Šå›ã¯ã€ã€Œã™ã¹ã¦ã®ãƒ¢ãƒ‡ãƒ«ã«å¯¾ã—ã¦ã‚¯ã‚¨ãƒªã€ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã€ã‚’é¸æŠã—ã¾ã™ã€‚ã“ã‚Œã§ GraphQL API ã®ä½œæˆã¯å®Œäº†ã§ã™ï¼

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2023-12-22 13.31.31.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3625536/9be8fb68-3655-102d-1941-dd5928b7a5d1.png)

## Step4. å‹•ä½œç¢ºèª

ã§ã¯ã€å®Ÿéš›ã«ã©ã‚“ãªã‚¹ã‚­ãƒ¼ãƒã‚„ãƒªã‚¾ãƒ«ãƒãƒ¼ãŒä½œæˆã•ã‚ŒãŸã‹è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã¾ãšã¯ã‚¹ã‚­ãƒ¼ãƒã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### ç¢ºèª 1 : GraphQL ã‚¹ã‚­ãƒ¼ãƒ

ä»¥ä¸‹ãŒè‡ªå‹•ã§ç”Ÿæˆã•ã‚ŒãŸã‚¹ã‚­ãƒ¼ãƒã§ã™ã€‚Aurora PostgreSQL ã§è©¦ã—ãŸã¨ãã¨åŒæ§˜ã«ã‚¹ã‚­ãƒ¼ãƒãŒæ­£ã—ãä½œæˆã§ãã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

<details><summary> schema.graphql </summary>

```graphql:schema.graphql
type Conversation {
	id: Int!
	name: String!
	created_at: String
}

type ConversationConnection {
	items: [Conversation]
	nextToken: String
}

input CreateConversationInput {
	id: Int!
	name: String!
	created_at: String
}

input CreateMessageInput {
	id: String!
	conversation_id: Int!
	sub: String!
	body: String!
	created_at: String
}

input CreateParticipantInput {
	conversation_id: Int!
	sub: String!
	last_read_at: String
}

input DeleteConversationInput {
	id: Int!
}

input DeleteMessageInput {
	id: String!
}

input DeleteParticipantInput {
	conversation_id: Int!
	sub: String!
}

type Message {
	id: String!
	conversation_id: Int!
	sub: String!
	body: String!
	created_at: String
}

type MessageConnection {
	items: [Message]
	nextToken: String
}

input ModelSizeInput {
	ne: Int
	eq: Int
	le: Int
	lt: Int
	ge: Int
	gt: Int
	between: [Int]
}

enum ModelSortDirection {
	ASC
	DESC
}

input OrderByConversationInput {
	id: ModelSortDirection
	name: ModelSortDirection
	created_at: ModelSortDirection
}

input OrderByMessageInput {
	id: ModelSortDirection
	conversation_id: ModelSortDirection
	sub: ModelSortDirection
	body: ModelSortDirection
	created_at: ModelSortDirection
}

input OrderByParticipantInput {
	conversation_id: ModelSortDirection
	sub: ModelSortDirection
	last_read_at: ModelSortDirection
}

type Participant {
	conversation_id: Int!
	sub: String!
	last_read_at: String
}

type ParticipantConnection {
	items: [Participant]
	nextToken: String
}

input TableConversationConditionInput {
	name: TableStringFilterInput
	created_at: TableStringFilterInput
	and: [TableConversationConditionInput]
	or: [TableConversationConditionInput]
	not: [TableConversationConditionInput]
}

input TableConversationFilterInput {
	id: TableIntFilterInput
	name: TableStringFilterInput
	created_at: TableStringFilterInput
	and: [TableConversationFilterInput]
	or: [TableConversationFilterInput]
	not: [TableConversationFilterInput]
}

input TableIntFilterInput {
	ne: Int
	eq: Int
	le: Int
	lt: Int
	ge: Int
	gt: Int
	between: [Int]
	attributeExists: Boolean
}

input TableMessageConditionInput {
	conversation_id: TableIntFilterInput
	sub: TableStringFilterInput
	body: TableStringFilterInput
	created_at: TableStringFilterInput
	and: [TableMessageConditionInput]
	or: [TableMessageConditionInput]
	not: [TableMessageConditionInput]
}

input TableMessageFilterInput {
	id: TableStringFilterInput
	conversation_id: TableIntFilterInput
	sub: TableStringFilterInput
	body: TableStringFilterInput
	created_at: TableStringFilterInput
	and: [TableMessageFilterInput]
	or: [TableMessageFilterInput]
	not: [TableMessageFilterInput]
}

input TableParticipantConditionInput {
	last_read_at: TableStringFilterInput
	and: [TableParticipantConditionInput]
	or: [TableParticipantConditionInput]
	not: [TableParticipantConditionInput]
}

input TableParticipantFilterInput {
	conversation_id: TableIntFilterInput
	sub: TableStringFilterInput
	last_read_at: TableStringFilterInput
	and: [TableParticipantFilterInput]
	or: [TableParticipantFilterInput]
	not: [TableParticipantFilterInput]
}

input TableStringFilterInput {
	ne: String
	eq: String
	le: String
	lt: String
	ge: String
	gt: String
	contains: String
	notContains: String
	between: [String]
	beginsWith: String
	attributeExists: Boolean
	size: ModelSizeInput
}

input UpdateConversationInput {
	id: Int!
	name: String
	created_at: String
}

input UpdateMessageInput {
	id: String!
	conversation_id: Int
	sub: String
	body: String
	created_at: String
}

input UpdateParticipantInput {
	conversation_id: Int!
	sub: String!
	last_read_at: String
}

type Mutation {
	createParticipant(input: CreateParticipantInput!): Participant
	updateParticipant(input: UpdateParticipantInput!, condition: TableParticipantConditionInput): Participant
	deleteParticipant(input: DeleteParticipantInput!, condition: TableParticipantConditionInput): Participant
	createConversation(input: CreateConversationInput!): Conversation
	updateConversation(input: UpdateConversationInput!, condition: TableConversationConditionInput): Conversation
	deleteConversation(input: DeleteConversationInput!, condition: TableConversationConditionInput): Conversation
	createMessage(input: CreateMessageInput!): Message
	updateMessage(input: UpdateMessageInput!, condition: TableMessageConditionInput): Message
	deleteMessage(input: DeleteMessageInput!, condition: TableMessageConditionInput): Message
}

type Query {
	getParticipant(conversation_id: Int!, sub: String!): Participant
	listParticipants(
		filter: TableParticipantFilterInput,
		limit: Int,
		orderBy: [OrderByParticipantInput],
		nextToken: String
	): ParticipantConnection
	getConversation(id: Int!): Conversation
	listConversations(
		filter: TableConversationFilterInput,
		limit: Int,
		orderBy: [OrderByConversationInput],
		nextToken: String
	): ConversationConnection
	getMessage(id: String!): Message
	listMessages(
		filter: TableMessageFilterInput,
		limit: Int,
		orderBy: [OrderByMessageInput],
		nextToken: String
	): MessageConnection
}

type Subscription {
	onCreateParticipant(conversation_id: Int, sub: String, last_read_at: String): Participant
		@aws_subscribe(mutations: ["createParticipant"])
	onUpdateParticipant(conversation_id: Int, sub: String, last_read_at: String): Participant
		@aws_subscribe(mutations: ["updateParticipant"])
	onDeleteParticipant(conversation_id: Int, sub: String, last_read_at: String): Participant
		@aws_subscribe(mutations: ["deleteParticipant"])
	onCreateConversation(id: Int, name: String, created_at: String): Conversation
		@aws_subscribe(mutations: ["createConversation"])
	onUpdateConversation(id: Int, name: String, created_at: String): Conversation
		@aws_subscribe(mutations: ["updateConversation"])
	onDeleteConversation(id: Int, name: String, created_at: String): Conversation
		@aws_subscribe(mutations: ["deleteConversation"])
	onCreateMessage(
		id: String,
		conversation_id: Int,
		sub: String,
		body: String,
		created_at: String
	): Message
		@aws_subscribe(mutations: ["createMessage"])
	onUpdateMessage(
		id: String,
		conversation_id: Int,
		sub: String,
		body: String,
		created_at: String
	): Message
		@aws_subscribe(mutations: ["updateMessage"])
	onDeleteMessage(
		id: String,
		conversation_id: Int,
		sub: String,
		body: String,
		created_at: String
	): Message
		@aws_subscribe(mutations: ["deleteMessage"])
}
```
</details>

### ç¢ºèª 2 : ãƒªã‚¾ãƒ«ãƒãƒ¼
æ¬¡ã«ã€ãƒªã‚¾ãƒ«ãƒãƒ¼ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚ä»¥ä¸‹ã¯ `createMessage` ã®ãƒªã‚¾ãƒ«ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚
JavaScript ã§æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§èª­ã¿ã‚„ã™ã„ã§ã™ã­ã€‚

```javascript
import { util } from '@aws-appsync/utils';
import { insert, createPgStatement, toJsonObject } from '@aws-appsync/utils/rds';

/**
 * Puts an item into the messages table using the supplied input.
 * @param {import('@aws-appsync/utils').Context} ctx the context
 * @returns {*} the request
 */
export function request(ctx) {
    const { input } = ctx.args;
    const insertStatement = insert({
        table: 'messages',
        values: input,
        returning: '*',
    });
    return createPgStatement(insertStatement)
}

/**
 * Returns the result or throws an error if the operation failed.
 * @param {import('@aws-appsync/utils').Context} ctx the context
 * @returns {*} the result
 */
export function response(ctx) {
    const { error, result } = ctx;
    if (error) {
        return util.appendError(
            error.message,
            error.type,
            result
        )
    }
    return toJsonObject(result)[0][0]
}
```

### ç¢ºèª 3 : GraphQL ã‚¹ã‚­ãƒ¼ãƒã®ä½œæˆã‚¿ã‚¤ãƒŸãƒ³ã‚°
æœ€å¾Œã« AWS AppSync ã® GraphQL ã‚¹ã‚­ãƒ¼ãƒä½œæˆã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ãŸã€‚
`conversations` ãƒ†ãƒ¼ãƒ–ãƒ«ã« `status` ã¨ã„ã†ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã¦ã¿ã¾ã—ãŸã€‚

```sql
ALTER TABLE conversations ADD COLUMN status VARCHAR(100);
```
ã“ã‚Œã§ã€ AWS AppSync ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å´ã§ã‚¹ã‚­ãƒ¼ãƒã®åæ˜ ãŒã§ãã‚Œã°...ã¨æ€ã„ã¾ã—ãŸãŒã€ç¾æ™‚ç‚¹ (2024 å¹´ 10 æœˆ 2 æ—¥) æ™‚ç‚¹ã§ã¯ã‚¹ã‚­ãƒ¼ãƒã®åæ˜ ã¯ GraphQL API ã‚’æ–°è¦ä½œæˆã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã ã‘ã§ã—ãŸã€‚ä½œæˆã•ã‚ŒãŸ `schema.graphql` ã«æ‰‹ã‚’åŠ ãˆã¦ã„ã‚‹å ´åˆ (ä¾‹ãˆã°ã€åˆ¥ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’æ¥ç¶šã—ãŸã€ãªã©)ã€ä¸Šæ›¸ãã•ã‚Œã¦ã—ã¾ã†ãƒªã‚¹ã‚¯ã‚‚ã‚ã‚‹ã®ã§ã€ã‚ã¾ã‚Šå¿…è¦ã§ã¯ãªã„ã®ã‹ãªã¨æ€ã„ã¾ã—ãŸã€‚ã“ã“ã¯ãœã²è‰²ã‚“ãªæ–¹ã®æ„è¦‹ã‚‚ä¼ºã„ãŸã„ã§ã™ã€‚

## ã¾ã¨ã‚

ä»Šå›ã¯ã€AWS AppSync ã® RDS Data API ã‚’ä½¿ç”¨ã—ã¦ Amazon Aurora Serverless v2 (MySQL) ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å¯¾ã—ã¦[ã‚¤ãƒ³ãƒˆãƒ­ã‚¹ãƒšã‚¯ã‚·ãƒ§ãƒ³](https://graphql.org/learn/introspection/)ã‚’è¡Œã†ã“ã¨ã§ã€æ¤œå‡ºã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«ã«é©åˆã—ãŸ GraphQL API ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’ä½œæˆã™ã‚‹æ©Ÿèƒ½ã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚é‚ã«ã€Aurora ã®ä»»æ„ã®ã‚¨ãƒ³ã‚¸ãƒ³ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚¿ã‚¤ãƒ—ã§ RDS Data API ã‚’ä½¿ã£ã¦ GraphQL API ã‚’çˆ†é€Ÿæ§‹ç¯‰ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã“ã¨ã¯å¬‰ã—ã„ã§ã™ã­ã€‚

